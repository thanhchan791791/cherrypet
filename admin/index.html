<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Quản lý thú theo chi nhánh - Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 480px;
      margin: 30px auto;
      padding: 15px;
      background: #f9f9f9;
    }
    h1, h2, h3 {
      text-align: center;
    }
    button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      margin: 5px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    #branchSelection button {
      width: 48%;
    }
    #addAnimalSection {
      margin-top: 10px;
      display: none;
      flex-wrap: nowrap;
      gap: 10px;
    }
    #addAnimalSection input {
      flex-grow: 1;
      padding: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    #addAnimalSection button {
      width: 100px;
      background-color: #28a745;
      margin-left: 0;
    }
    #addAnimalSection button:hover {
      background-color: #1e7e34;
    }
    ul {
      list-style: none;
      padding-left: 0;
      margin-top: 20px;
    }
    ul li {
      background: white;
      margin-bottom: 8px;
      padding: 10px 15px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    ul li span.animalName {
      flex-grow: 1;
      cursor: pointer;
      user-select: none;
    }
    ul li span.animalName:hover {
      text-decoration: underline;
    }
    .deleteBtn {
      background-color: #dc3545;
      padding: 5px 12px;
      font-size: 0.9rem;
      border-radius: 6px;
      margin-left: 10px;
      flex-shrink: 0;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
    }
    .deleteBtn:hover {
      background-color: #b02a37;
    }
    #backBtn {
      background-color: #6c757d;
      margin-top: 15px;
      width: 100%;
    }
    #backBtn:hover {
      background-color: #5a6268;
    }
    #attributeManager {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 20px;
      display: none;
    }
    #addAttributeForm {
      margin-top: 15px;
      gap: 10px;
      display: none;
      flex-wrap: wrap;
      align-items: center;
    }
    #addAttributeForm input[type="text"] {
      flex: 1 1 70%;
      padding: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #addAttributeForm button {
      flex: 1 1 100px;
      background-color: #28a745;
      margin-left: 10px;
    }
    #addAttributeForm button:hover {
      background-color: #1e7e34;
    }
    #attributesList {
      margin-top: 15px;
      list-style: none;
      padding-left: 0;
    }
    #attributesList li {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 8px;
      background: #fafafa;
    }
    #attributesList li span {
      flex-grow: 1;
    }
    #attributesList li button {
      background-color: #dc3545;
      font-size: 0.85rem;
      padding: 4px 8px;
      border-radius: 4px;
      margin-left: 10px;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
    }
    #attributesList li button:hover {
      background-color: #b02a37;
    }
    /* Form thêm từng con thú */
    #addInstanceForm {
      gap: 10px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 20px;
    }
    #addInstanceForm input[type="text"] {
      flex: 1 1 45%;
      padding: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #addInstanceForm button {
      flex: 1 1 100px;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      padding: 10px;
      border: none;
      font-weight: bold;
      margin-top: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #addInstanceForm button:hover {
      background-color: #0056b3;
    }
    #instanceList {
      margin-top: 15px;
      list-style:none;
      padding-left: 0;
    }
    #instanceList li {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      padding: 10px 15px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #instanceList li button {
      background-color: #dc3545;
      padding: 5px 12px;
      font-size: 0.9rem;
      border-radius: 6px;
      margin-left: 10px;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
    }
    #instanceList li button:hover {
      background-color: #b02a37;
    }
  </style>
</head>
<body>

  <h1>Chọn chi nhánh</h1>
  <div id="branchSelection">
    <button id="btnSaigon">Sài Gòn</button>
    <button id="btnDalat">Đà Lạt</button>
  </div>

  <div id="managerSection" style="display:none;">
    <h2>Quản lý thú chi nhánh: <span id="branchName"></span></h2>

    <button id="showAddAnimalBtn">+ Thêm thú</button>

    <div id="addAnimalSection" style="display:flex;">
      <input type="text" id="animalNameInput" placeholder="Nhập tên thú..." />
      <button id="saveAnimalBtn">Lưu</button>
    </div>

    <ul id="animalList">
      <li><i>Đang tải danh sách thú...</i></li>
    </ul>

    <button id="backBtn">← Quay lại chọn chi nhánh</button>

    <div id="attributeManager">
      <h3>Quản lý thuộc tính cho thú: <span id="selectedAnimalName"></span></h3>
      <button id="showAddAttributeBtn">+ Thêm thuộc tính</button>

      <form id="addAttributeForm">
        <input type="text" id="attributeNameInput" placeholder="Tên thuộc tính" required />
        <button type="submit">Lưu thuộc tính</button>
      </form>

      <ul id="attributesList"></ul>

      <hr />

      <h3>Thêm từng con thú cho: <span id="selectedAnimalName2"></span></h3>

      <form id="addInstanceForm">
        <div id="instanceInputsContainer"></div>
        <button type="submit">Thêm con thú</button>
      </form>

      <ul id="instanceList"></ul>
    </div>
  </div>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
    authDomain: "saigon-dalat.firebaseapp.com",
    databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
    projectId: "saigon-dalat",
    storageBucket: "saigon-dalat.firebasestorage.app",
    messagingSenderId: "339735183485",
    appId: "1:339735183485:web:bc23cd740104d272577114",
    measurementId: "G-FDLZXR2X8P"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // DOM elements
  const branchSelection = document.getElementById('branchSelection');
  const managerSection = document.getElementById('managerSection');
  const branchNameSpan = document.getElementById('branchName');
  const showAddAnimalBtn = document.getElementById('showAddAnimalBtn');
  const addAnimalSection = document.getElementById('addAnimalSection');
  const animalNameInput = document.getElementById('animalNameInput');
  const saveAnimalBtn = document.getElementById('saveAnimalBtn');
  const animalListUl = document.getElementById('animalList');
  const backBtn = document.getElementById('backBtn');

  const attributeManager = document.getElementById('attributeManager');
  const selectedAnimalNameSpan = document.getElementById('selectedAnimalName');
  const selectedAnimalNameSpan2 = document.getElementById('selectedAnimalName2');
  const showAddAttributeBtn = document.getElementById('showAddAttributeBtn');
  const addAttributeForm = document.getElementById('addAttributeForm');
  const attributeNameInput = document.getElementById('attributeNameInput');
  const attributesListUl = document.getElementById('attributesList');

  const addInstanceForm = document.getElementById('addInstanceForm');
  const instanceInputsContainer = document.getElementById('instanceInputsContainer');
  const instanceListUl = document.getElementById('instanceList');

  let currentBranch = null;
  let animalsRef = null;
  let selectedAnimal = null;
  let attributesData = {};
  let attributesOrder = []; // lưu thứ tự thuộc tính đã đảo dùng cho input và danh sách

  // Load danh sách thú theo chi nhánh
  function loadAnimals(branch) {
    animalsRef = ref(db, `cities/${branch}/animals`);
    animalListUl.innerHTML = '<li><i>Đang tải danh sách thú...</i></li>';

    onValue(animalsRef, snapshot => {
      const data = snapshot.val();
      animalListUl.innerHTML = '';

      if (!data) {
        animalListUl.innerHTML = '<li><i>Chưa có thú nào.</i></li>';
        attributeManager.style.display = 'none';
        selectedAnimal = null;
        return;
      }

      for (const animalName of Object.keys(data)) {
        const li = document.createElement('li');

        const span = document.createElement('span');
        span.textContent = animalName;
        span.classList.add('animalName');
        span.title = 'Click để quản lý thuộc tính và từng con thú';
        span.addEventListener('click', () => {
          selectAnimal(animalName);
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Xóa';
        deleteBtn.classList.add('deleteBtn');
        deleteBtn.addEventListener('click', () => {
          if (confirm(`Bạn có chắc muốn xóa thú "${animalName}"?`)) {
            remove(ref(db, `cities/${currentBranch}/animals/${animalName}`));
            if(selectedAnimal === animalName){
              attributeManager.style.display = 'none';
              selectedAnimal = null;
            }
          }
        });

        li.appendChild(span);
        li.appendChild(deleteBtn);
        animalListUl.appendChild(li);
      }
    });
  }

  // Chọn chi nhánh
  function selectBranch(branch) {
    currentBranch = branch;
    branchNameSpan.textContent = branch;
    branchSelection.style.display = 'none';
    managerSection.style.display = 'block';
    addAnimalSection.style.display = 'none';
    animalNameInput.value = '';
    attributeManager.style.display = 'none';
    selectedAnimal = null;
    loadAnimals(branch);
  }

  // Chọn thú để quản lý thuộc tính và từng con
  function selectAnimal(animalName) {
    selectedAnimal = animalName;
    selectedAnimalNameSpan.textContent = animalName;
    selectedAnimalNameSpan2.textContent = animalName;
    attributeManager.style.display = 'block';
    addAttributeForm.style.display = 'none';
    attributeNameInput.value = '';
    loadAttributes(animalName);
    loadInstances(animalName);
    clearInstanceForm();
  }

  function loadAttributes(animalName) {
    const attributesRef = ref(db, `cities/${currentBranch}/animals/${animalName}/attributes`);
    attributesListUl.innerHTML = '<li><i>Đang tải thuộc tính...</i></li>';
    attributesData = {};
    attributesOrder = [];

    onValue(attributesRef, snapshot => {
      const data = snapshot.val();
      attributesListUl.innerHTML = '';

      if (!data) {
        attributesListUl.innerHTML = '<li><i>Chưa có thuộc tính nào.</i></li>';
        attributesData = {};
        attributesOrder = [];
        renderInstanceFormInputs();
        return;
      }

      attributesData = data;

      // Đảo ngược thứ tự thuộc tính để cái thêm mới hiện lên đầu
      attributesOrder = Object.keys(data).reverse(); // lưu thứ tự đảo để dùng chung

      for (const attrName of attributesOrder) {
        const li = document.createElement('li');

        const span = document.createElement('span');
        span.textContent = attrName;
        li.appendChild(span);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Xóa';
        deleteBtn.addEventListener('click', () => {
          if (confirm(`Bạn có chắc muốn xóa thuộc tính "${attrName}"?`)) {
            remove(ref(db, `cities/${currentBranch}/animals/${selectedAnimal}/attributes/${attrName}`));
          }
        });

        li.appendChild(deleteBtn);
        attributesListUl.appendChild(li);
      }

      renderInstanceFormInputs();
    });
  }

  // Tạo input tương ứng các thuộc tính để thêm từng con thú
  function renderInstanceFormInputs() {
    instanceInputsContainer.innerHTML = '';
    if (!attributesOrder || attributesOrder.length === 0) {
      instanceInputsContainer.innerHTML = '<i>Vui lòng thêm thuộc tính trước khi thêm từng con thú.</i>';
      addInstanceForm.style.display = 'none';
      return;
    }
    addInstanceForm.style.display = 'flex';

    // Dùng đúng thứ tự đã đảo trong attributesOrder để tạo input
    for (const attrName of attributesOrder) {
      const input = document.createElement('input');
      input.type = 'text';
      input.name = attrName;
      input.placeholder = attrName;
      input.required = true;
      instanceInputsContainer.appendChild(input);
    }
  }

  // Xóa giá trị nhập form thêm con thú
  function clearInstanceForm() {
    for (const input of instanceInputsContainer.querySelectorAll('input')) {
      input.value = '';
    }
  }

  // Load danh sách từng con thú
  function loadInstances(animalName) {
    const instancesRef = ref(db, `cities/${currentBranch}/animals/${animalName}/instances`);
    instanceListUl.innerHTML = '<li><i>Đang tải danh sách con thú...</i></li>';

    onValue(instancesRef, snapshot => {
      const data = snapshot.val();
      instanceListUl.innerHTML = '';

      if (!data) {
        instanceListUl.innerHTML = '<li><i>Chưa có con thú nào.</i></li>';
        return;
      }

      for (const [instanceId, instanceData] of Object.entries(data)) {
        const li = document.createElement('li');
        const textParts = [];

        for (const attrName of attributesOrder) {
          textParts.push(`${attrName}: ${instanceData[attrName] || ''}`);
        }

        li.textContent = textParts.join(' | ');

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Xóa';
        deleteBtn.addEventListener('click', () => {
          if (confirm('Bạn có chắc muốn xóa con thú này?')) {
            remove(ref(db, `cities/${currentBranch}/animals/${selectedAnimal}/instances/${instanceId}`));
          }
        });

        li.appendChild(deleteBtn);
        instanceListUl.appendChild(li);
      }
    });
  }

  // Xử lý submit form thêm từng con thú
  addInstanceForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!selectedAnimal) {
      alert('Vui lòng chọn thú trước.');
      return;
    }

    const formData = new FormData(addInstanceForm);
    const newInstance = {};

    for (const attrName of attributesOrder) {
      const val = formData.get(attrName);
      if (!val) {
        alert(`Bạn phải nhập giá trị cho thuộc tính "${attrName}"!`);
        return;
      }
      newInstance[attrName] = val;
    }

    const newInstanceId = Date.now().toString();
    const instanceRef = ref(db, `cities/${currentBranch}/animals/${selectedAnimal}/instances/${newInstanceId}`);

    set(instanceRef, newInstance)
    .then(() => {
      alert(`Đã thêm con thú mới cho "${selectedAnimal}"`);
      clearInstanceForm();
    })
    .catch(err => {
      alert('Lỗi khi thêm con thú: ' + err.message);
      console.error(err);
    });
  });

  // Nút chọn chi nhánh
  document.getElementById('btnSaigon').addEventListener('click', () => selectBranch('Saigon'));
  document.getElementById('btnDalat').addEventListener('click', () => selectBranch('Dalat'));

  // Nút thêm thú
  showAddAnimalBtn.addEventListener('click', () => {
    if (addAnimalSection.style.display === 'flex') {
      addAnimalSection.style.display = 'none';
    } else {
      addAnimalSection.style.display = 'flex';
      animalNameInput.value = '';
      animalNameInput.focus();
    }
  });

  // Lưu thú mới
  saveAnimalBtn.addEventListener('click', () => {
    const name = animalNameInput.value.trim();
    if (!name) {
      alert("Bạn phải nhập tên thú!");
      return;
    }

    const animalRef = ref(db, `cities/${currentBranch}/animals/${name}`);

    set(animalRef, {
      createdAt: Date.now()
    })
    .then(() => {
      alert(`Đã thêm thú "${name}" thành công!`);
      animalNameInput.value = '';
      addAnimalSection.style.display = 'none';
    })
    .catch(error => {
      alert("Lỗi khi thêm thú: " + error.message);
      console.error(error);
    });
  });

  // === PHẦN THÊM Ở ĐÂY: XỬ LÝ THÊM THUỘC TÍNH ===
  // Hiển thị ẩn form thêm thuộc tính khi nhấn nút
  showAddAttributeBtn.addEventListener('click', () => {
    if (addAttributeForm.style.display === 'flex' || addAttributeForm.style.display === 'block') {
      addAttributeForm.style.display = 'none';
    } else {
      addAttributeForm.style.display = 'flex';
      attributeNameInput.value = '';
      attributeNameInput.focus();
    }
  });

  // Xử lý submit form thêm thuộc tính
  addAttributeForm.addEventListener('submit', e => {
    e.preventDefault();

    if (!selectedAnimal) {
      alert('Vui lòng chọn thú trước.');
      return;
    }

    const attrName = attributeNameInput.value.trim();
    if (!attrName) {
      alert('Bạn phải nhập tên thuộc tính!');
      return;
    }

    // Tham chiếu đến thuộc tính mới trong Firebase
    const attrRef = ref(db, `cities/${currentBranch}/animals/${selectedAnimal}/attributes/${attrName}`);

    // Lưu thuộc tính mới (ở đây chỉ lưu true hoặc giá trị bất kỳ)
    set(attrRef, true)
    .then(() => {
      alert(`Đã thêm thuộc tính "${attrName}" thành công!`);
      attributeNameInput.value = '';
      addAttributeForm.style.display = 'none';
    })
    .catch(error => {
      alert('Lỗi khi thêm thuộc tính: ' + error.message);
      console.error(error);
    });
  });
  // === HẾT PHẦN THÊM ===

  // Nút quay lại chọn chi nhánh
  backBtn.addEventListener('click', () => {
    currentBranch = null;
    branchSelection.style.display = 'block';
    managerSection.style.display = 'none';
    animalListUl.innerHTML = '';
    animalNameInput.value = '';
    addAnimalSection.style.display = 'none';
    attributeManager.style.display = 'none';
    selectedAnimal = null;
    attributesOrder = [];
    attributesData = {};
  });
</script>

</body>
</html>
