<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Qu·∫£n l√Ω th√∫ - Giao di·ªán hi·ªán ƒë·∫°i</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
  @media(max-width:480px){
  #instance-table{
    display:block;
    width:100%;
    border:none;
    box-shadow:none;
  }

  #instance-header{ display:none; }

  #instance-body tr{
    display:block;
    margin-bottom:16px;
    background:#fff;
    padding:12px 16px;
    border-radius:16px;
    box-shadow:0 6px 16px rgba(0,0,0,0.08);
  }

  #instance-body td{
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    border:none;
    font-size:0.95rem;
  }

  #instance-body td::before{
    content: attr(data-label);
    font-weight:600;
    color:#555;
    margin-right:8px;
    flex-shrink:0;
  }

  #instance-body td button{
    margin:0 4px 0 0;
    flex-shrink:0;
  }

  #instance-body td img{
    width:50px;
    height:50px;
    margin-right:6px;
  }
}

  /* ===== Reset ===== */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Poppins', Arial, sans-serif; background: linear-gradient(135deg,#fdfbfb,#e0f7fa); display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; color:#333; min-height:100vh; overflow-x:hidden; }
  section { background:#fff; padding:24px; border-radius:24px; width:100%; max-width:480px; margin-bottom:30px; box-shadow:0 8px 24px rgba(0,0,0,0.12); transition:all 0.5s ease; opacity:1; transform:translateY(0); }
  section.hidden { opacity:0; transform:translateY(30px); pointer-events:none; }
  h2{font-size:1.8rem;margin-bottom:12px;color:#333;text-align:center;} h3{font-size:1.4rem;margin-bottom:12px;} h4{font-size:1.2rem;margin-bottom:8px;}
  button{cursor:pointer;border:none;border-radius:14px;padding:14px 20px;font-weight:600;font-size:1rem;transition:all 0.3s ease;display:inline-flex;align-items:center;gap:8px;}
  button:hover{transform:scale(1.05);} button:active{transform:scale(0.98);}
  .btn-primary{background:#ff9ff3;color:#fff;} .btn-primary:hover{background:#f368e0;}
  .btn-danger{background:#ee5253;color:#fff;} .btn-danger:hover{background:#c23616;}
  .btn-update{background:#feca57;color:#fff;} .btn-update:hover{background:#ff9f43;}
  .btn-show{background:#54a0ff;color:#fff;margin-bottom:12px;} .btn-show:hover{background:#2e86de;}
  .back-btn{background:#48dbfb;margin-bottom:20px;} .back-btn:hover{background:#00a8ff;}
  input[type="text"]{width:100%;padding:14px;border-radius:14px;border:1px solid #ccc;margin-bottom:14px;font-size:1rem;transition:all 0.3s ease;}
  input[type="text"]:focus{border-color:#54a0ff;outline:none;}
  ul{list-style:none;padding:0;margin:12px 0;}
  ul li{background:#fefefe;border-radius:16px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 6px 18px rgba(0,0,0,0.08);transition:all 0.3s ease;}
  ul li:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 8px 20px rgba(0,0,0,0.12);}
  #instance-table{width:100%;border-collapse:collapse;margin-top:16px;border-radius:16px;overflow:auto;display:block;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
  th, td{padding:14px;text-align:left;font-size:1rem;white-space:nowrap;}
  th{background:#ff9ff3;color:#fff;font-weight:600;} td{background:#fff;} td button{margin-left:6px;}
  .hidden{display:none;}
  #toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) translateY(30px);background:rgba(0,0,0,0.85);color:#fff;padding:16px 24px;border-radius:16px;font-size:1rem;font-weight:600;opacity:0;pointer-events:none;transition:all 0.5s ease;z-index:1000;}
  #toast.show{opacity:1;transform:translate(-50%,-50%) translateY(0);}
  .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;opacity:0;pointer-events:none;transition:all 0.3s ease;padding:16px;z-index:999;}
  .modal-overlay.show{opacity:1;pointer-events:all;}
  .modal{background:#fff;border-radius:20px;padding:24px;width:100%;max-width:400px;box-shadow:0 10px 30px rgba(0,0,0,0.2);transform:translateY(-30px);transition:all 0.3s ease;}
  .modal.show{transform:translateY(0);}
  .modal h3{margin-bottom:16px;}
  .modal input{margin-bottom:12px;}
  .modal .modal-close{background:#ee5253;color:#fff;float:right;margin-top:-8px;}
  #branch-list{display:flex;justify-content:center;gap:20px;flex-wrap:wrap;margin-top:20px;}
  #branch-list li{background:#54a0ff;border-radius:24px;width:140px;height:140px;display:flex;justify-content:center;align-items:center;color:#fff;font-size:1.1rem;font-weight:600;box-shadow:0 6px 18px rgba(0,0,0,0.15);transition:all 0.4s ease;opacity:0;transform:translateY(30px);cursor:pointer;flex-direction:column;text-align:center;}
  #branch-list li.show{opacity:1;transform:translateY(0);}
  #branch-list li:hover{transform:translateY(-5px) scale(1.05);box-shadow:0 10px 20px rgba(0,0,0,0.2);background:#2e86de;}
  @media(max-width:480px){section{padding:20px;max-width:95%;} input[type="text"]{padding:12px;font-size:1rem;} button{padding:12px 18px;font-size:1rem;} th,td{padding:12px;font-size:0.95rem;} #branch-list li{width:120px;height:120px;font-size:1rem;} #instance-table{display:block;overflow-x:auto;}}
</style>
</head>
<body>

<div id="toast"></div>

<section id="step-branch">
  <h2>üè¢ Ch·ªçn chi nh√°nh</h2>
  <ul id="branch-list"></ul>
</section>

<section id="step-animals" class="hidden">
  <button class="back-btn" id="back-to-branch"><i class="fas fa-arrow-left"></i> Quay l·∫°i chi nh√°nh</button>
  <h2>Chi nh√°nh: <span id="branch-name"></span></h2>
  <h3> Danh s√°ch th√∫</h3>
  <ul id="animal-list"></ul>
  <button class="btn-show" id="show-add-animal-form"><i class="fas fa-plus"></i> Th√™m th√∫ m·ªõi</button>
</section>

<section id="step-animal-detail" class="hidden">
  <button class="back-btn" id="back-to-animals"><i class="fas fa-arrow-left"></i> Quay l·∫°i danh s√°ch th√∫</button>
  <h2>Chi nh√°nh: <span id="detail-branch-name"></span></h2>
  <h3> Th√∫: <span id="detail-animal-name"></span></h3>
  <h4>Thu·ªôc t√≠nh</h4>
  <ul id="attr-list"></ul>
  <button class="btn-show" id="show-add-attr-form"><i class="fas fa-plus"></i> Th√™m thu·ªôc t√≠nh</button>
  <h4>T·ª´ng con th√∫</h4>
  <button class="btn-show" id="show-add-instance-form"><i class="fas fa-plus"></i> Th√™m/C·∫≠p nh·∫≠t con th√∫</button>
  <table id="instance-table">
    <thead><tr id="instance-header"></tr></thead>
    <tbody id="instance-body"></tbody>
  </table>
</section>

<div class="modal-overlay" id="modal-animal">
  <div class="modal">
    <button class="modal-close" id="close-modal-animal">ƒê√≥ng</button>
    <h3>Th√™m th√∫ m·ªõi</h3>
    <input type="text" id="new-animal-name" placeholder="T√™n th√∫ m·ªõi..." />
    <button class="btn-primary" id="add-animal-btn"><i class="fas fa-plus-circle"></i> Th√™m th√∫</button>
  </div>
</div>

<div class="modal-overlay" id="modal-attr">
  <div class="modal">
    <button class="modal-close" id="close-modal-attr">ƒê√≥ng</button>
    <h3>Th√™m thu·ªôc t√≠nh</h3>
    <input type="text" id="new-attr-name" placeholder="T√™n thu·ªôc t√≠nh m·ªõi..." />
    <button class="btn-primary" id="add-attr-btn"><i class="fas fa-plus-circle"></i> Th√™m thu·ªôc t√≠nh</button>
  </div>
</div>

<div class="modal-overlay" id="modal-instance">
  <div class="modal">
    <button class="modal-close" id="close-modal-instance">ƒê√≥ng</button>
    <h3>Th√™m / C·∫≠p nh·∫≠t con th√∫</h3>
    <form id="add-instance-form">
      <div id="instance-inputs"></div>
      <button type="submit" class="btn-primary"><i class="fas fa-save"></i> L∆∞u</button>
    </form>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
    authDomain: "saigon-dalat.firebaseapp.com",
    databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
    projectId: "saigon-dalat",
    storageBucket: "saigon-dalat.appspot.com",
    messagingSenderId: "339735183485",
    appId: "1:339735183485:web:bc23cd740104d272577114"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  console.log("Firebase initialized");

  // ===== Variables =====
  let currentBranch=null, currentAnimal=null, editIndex=-1;

  const stepBranch=document.getElementById('step-branch');
  const stepAnimals=document.getElementById('step-animals');
  const stepAnimalDetail=document.getElementById('step-animal-detail');
  const branchListUl=document.getElementById('branch-list');
  const branchNameSpan=document.getElementById('branch-name');
  const animalList=document.getElementById('animal-list');
  const detailBranchNameSpan=document.getElementById('detail-branch-name');
  const detailAnimalNameSpan=document.getElementById('detail-animal-name');
  const attrList=document.getElementById('attr-list');
  const instanceHeader=document.getElementById('instance-header');
  const instanceBody=document.getElementById('instance-body');
  const instanceInputsDiv=document.getElementById('instance-inputs');
  const addInstanceForm=document.getElementById('add-instance-form');
  const toast=document.getElementById('toast');

  const modalAnimal=document.getElementById('modal-animal');
  const modalAttr=document.getElementById('modal-attr');
  const modalInstance=document.getElementById('modal-instance');

  const newAnimalNameInput=document.getElementById('new-animal-name');
  const addAnimalBtn=document.getElementById('add-animal-btn');
  const newAttrNameInput=document.getElementById('new-attr-name');
  const addAttrBtn=document.getElementById('add-attr-btn');

  function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show'); },2000); }

  // ===== Modal controls =====
  document.getElementById('show-add-animal-form').onclick = ()=>{ modalAnimal.classList.add('show'); modalAnimal.querySelector('.modal').classList.add('show'); };
  document.getElementById('close-modal-animal').onclick = ()=>{ modalAnimal.classList.remove('show'); modalAnimal.querySelector('.modal').classList.remove('show'); };
  document.getElementById('show-add-attr-form').onclick = ()=>{ modalAttr.classList.add('show'); modalAttr.querySelector('.modal').classList.add('show'); };
  document.getElementById('close-modal-attr').onclick = ()=>{ modalAttr.classList.remove('show'); modalAttr.querySelector('.modal').classList.remove('show'); };
  document.getElementById('show-add-instance-form').onclick = ()=>{
  // L·∫•y danh s√°ch thu·ªôc t√≠nh t·ª´ Firebase tr∆∞·ªõc khi t·∫°o form
  db.ref(`branches/${currentBranch}/animals/${currentAnimal}/attributes`).once('value').then(snapshot=>{
    const attrs = snapshot.val() || [];
    if(attrs.length === 0){
      showToast('Th√∫ n√†y ch∆∞a c√≥ thu·ªôc t√≠nh n√†o, h√£y th√™m thu·ªôc t√≠nh tr∆∞·ªõc!');
      return;
    }
    renderInstanceForm(attrs); // Truy·ªÅn thu·ªôc t√≠nh v√†o form
    modalInstance.classList.add('show'); 
    modalInstance.querySelector('.modal').classList.add('show');
  }).catch(err=>console.error(err));
};

  document.getElementById('close-modal-instance').onclick = ()=>{ modalInstance.classList.remove('show'); modalInstance.querySelector('.modal').classList.remove('show'); };

  // ===== Load branches from Firebase =====
  function loadBranches(){
    db.ref('branches').once('value').then(snapshot=>{
      const branches=snapshot.val()||{};
      branchListUl.innerHTML='';
      let i=0;
      for(const branchName in branches){
        const li=document.createElement('li');
        li.dataset.branch=branchName;
        li.innerHTML=`<i class="fas fa-city fa-2x"></i> ${branchName}`;
        branchListUl.appendChild(li);
        setTimeout(()=> li.classList.add('show'), i*200);
        i++;
        li.onclick=()=>{ currentBranch=branchName; branchNameSpan.textContent=currentBranch; stepBranch.classList.add('hidden'); stepAnimals.classList.remove('hidden'); renderAnimalList(); };
      }
    }).catch(err=>console.error("Error loading branches:",err));
  }

  loadBranches();
  document.getElementById('back-to-branch').onclick=()=>{ currentBranch=null; stepAnimals.classList.add('hidden'); stepBranch.classList.remove('hidden'); };

  // ===== Render Animal List =====
  function renderAnimalList(){
    db.ref(`branches/${currentBranch}/animals`).once('value').then(snapshot=>{
      const animals=snapshot.val()||{};
      animalList.innerHTML='';
      if(Object.keys(animals).length===0){ animalList.innerHTML='<li>Ch∆∞a c√≥ th√∫ n√†o.</li>'; return; }
      for(const name in animals){
        const li=document.createElement('li');
        const span=document.createElement('span'); span.textContent=name; li.appendChild(span);

        const btnDetail=document.createElement('button');
        btnDetail.innerHTML='<i class="fas fa-cog"></i> Qu·∫£n l√Ω'; btnDetail.classList.add('btn-update');
        btnDetail.onclick=()=>{ currentAnimal=name; openAnimalDetail(); };
        const btnDelete=document.createElement('button');
        btnDelete.innerHTML='<i class="fas fa-trash-alt"></i> X√≥a'; btnDelete.classList.add('btn-danger');
        btnDelete.onclick=()=>{ if(confirm(`X√≥a th√∫ "${name}"?`)){ 
          db.ref(`branches/${currentBranch}/animals/${name}`).remove().then(()=>{ showToast(`ƒê√£ x√≥a th√∫ "${name}"`); renderAnimalList(); }).catch(err=>console.error(err));
        }};
        li.appendChild(btnDetail); li.appendChild(btnDelete); animalList.appendChild(li);
      }
    }).catch(err=>console.error(err));
  }
addAnimalBtn.onclick = () => {
  const newName = newAnimalNameInput.value.trim();
  if (!newName) return alert('Nh·∫≠p t√™n th√∫ m·ªõi!');
  if (!currentBranch) return alert('Ch·ªçn chi nh√°nh tr∆∞·ªõc khi th√™m th√∫!');

  // Encode t√™n ƒë·ªÉ l√†m key h·ª£p l·ªá
  const keyName = newName.replace(/[.#$/\[\]]/g, '_').replace(/\s+/g,'_');

  db.ref(`branches/${currentBranch}/animals/${keyName}`).once('value').then(snapshot => {
    if (snapshot.exists()) return alert('Th√∫ ƒë√£ t·ªìn t·∫°i!');
    // L∆∞u name g·ªëc trong object
    db.ref(`branches/${currentBranch}/animals/${keyName}`).set({name: newName, attributes: [], instances: []})
      .then(() => {
        newAnimalNameInput.value = '';
        modalAnimal.classList.remove('show');
        modalAnimal.querySelector('.modal').classList.remove('show');
        renderAnimalList();
        showToast(`ƒê√£ th√™m th√∫ "${newName}"`);
        console.log(`Added animal ${newName}`);
      })
      .catch(err => console.error(err));
  });
};

 // ===== Animal Detail =====
function openAnimalDetail() {
  detailBranchNameSpan.textContent = currentBranch;
  detailAnimalNameSpan.textContent = currentAnimal;
  stepAnimals.classList.add('hidden');
  stepAnimalDetail.classList.remove('hidden');
  renderAnimalDetail();
}

document.getElementById('back-to-animals').onclick = () => {
  stepAnimalDetail.classList.add('hidden');
  stepAnimals.classList.remove('hidden');
  editIndex = -1;
};

// ===== Render Animal Detail =====
function renderAnimalDetail() {
  db.ref(`branches/${currentBranch}/animals/${currentAnimal}`).once('value')
    .then(snapshot => {
      const animalData = snapshot.val() || {};
      animalData.attributes = animalData.attributes || [];
      // N·∫øu instances l√† object, gi·ªØ nguy√™n; n·∫øu undefined th√¨ set {}
      animalData.instances = animalData.instances || {};

      // ===== Attributes =====
      attrList.innerHTML = '';
      if (animalData.attributes.length === 0) {
        attrList.innerHTML = '<li>Ch∆∞a c√≥ thu·ªôc t√≠nh n√†o.</li>';
      } else {
        animalData.attributes.forEach(attr => {
          const li = document.createElement('li');
          const span = document.createElement('span');
          span.textContent = attr;
          li.appendChild(span);

          const btnDelete = document.createElement('button');
          btnDelete.innerHTML = '<i class="fas fa-trash-alt"></i>';
          btnDelete.classList.add('btn-danger');

          btnDelete.onclick = () => {
            if (confirm(`X√≥a thu·ªôc t√≠nh "${attr}"?`)) {
              let updates = {};

              // X√≥a thu·ªôc t√≠nh trong m·∫£ng attributes
              updates[`branches/${currentBranch}/animals/${currentAnimal}/attributes`] =
                animalData.attributes.filter(a => a !== attr);

              // X√≥a thu·ªôc t√≠nh trong t·∫•t c·∫£ instances
              if (animalData.instances) {
                const instancesEntries = Object.entries(animalData.instances);
                instancesEntries.forEach(([key, inst]) => {
                  if (inst[attr] !== undefined) {
                    updates[`branches/${currentBranch}/animals/${currentAnimal}/instances/${key}/${attr}`] = null;
                  }
                });
              }

              db.ref().update(updates)
                .then(() => {
                  renderAnimalDetail();
                  showToast(`ƒê√£ x√≥a thu·ªôc t√≠nh "${attr}"`);
                  console.log(`Deleted attribute ${attr}`);
                })
                .catch(err => console.error(err));
            }
          };

          li.appendChild(btnDelete);
          attrList.appendChild(li);
        });
      }

      // ===== Instances =====
      renderInstanceTable(animalData);
    })
    .catch(err => console.error(err));
}

// ===== Add Attribute =====
addAttrBtn.onclick = () => {
  const newAttr = newAttrNameInput.value.trim();
  if (!newAttr) return alert('Nh·∫≠p t√™n thu·ªôc t√≠nh!');

  db.ref(`branches/${currentBranch}/animals/${currentAnimal}/attributes`).once('value')
    .then(snapshot => {
      const attrs = snapshot.val() || [];
      if (attrs.includes(newAttr)) return alert('Thu·ªôc t√≠nh ƒë√£ t·ªìn t·∫°i!');
      attrs.push(newAttr);
      db.ref(`branches/${currentBranch}/animals/${currentAnimal}/attributes`).set(attrs)
        .then(() => {
          newAttrNameInput.value = '';
          modalAttr.classList.remove('show');
          modalAttr.querySelector('.modal').classList.remove('show');
          renderAnimalDetail();
          showToast(`ƒê√£ th√™m thu·ªôc t√≠nh "${newAttr}"`);
          console.log(`Added attribute ${newAttr}`);
        })
        .catch(err => console.error(err));
    });
};
function renderInstanceTable(animalData) {
  instanceBody.innerHTML = '';

  const instances = animalData.instances ? Object.entries(animalData.instances) : [];
  if(instances.length === 0){
    instanceBody.innerHTML = '<tr><td colspan="100%">Ch∆∞a c√≥ con th√∫ n√†o.</td></tr>';
    return;
  }

  instances.forEach(([key, inst]) => {
    const tr = document.createElement('tr');

    // Desktop: table row
    animalData.attributes.forEach(attr => {
      const td = document.createElement('td');
      if(attr.toLowerCase() === 'h√¨nh ·∫£nh'){
        if(inst[attr] && inst[attr].length>0){
          inst[attr].forEach(url=>{
            const img = document.createElement('img');
            img.src = url;
            img.style.width='60px';
            img.style.height='60px';
            img.style.objectFit='cover';
            img.style.borderRadius='6px';
            img.style.marginRight='4px';
            td.appendChild(img);
          });
        }else td.textContent='Ch∆∞a c√≥ ·∫£nh';
      }else td.textContent = inst[attr] || '';
      td.dataset.label = attr;
      tr.appendChild(td);
    });

    // Thao t√°c
    const tdAction = document.createElement('td');
    tdAction.dataset.label = 'Thao t√°c';

    const btnEdit = document.createElement('button');
    btnEdit.innerHTML = '<i class="fas fa-edit"></i>';
    btnEdit.classList.add('btn-update');
    btnEdit.onclick = ()=>{ renderInstanceForm(animalData.attributes, inst); modalInstance.classList.add('show'); modalInstance.querySelector('.modal').classList.add('show'); };

    const btnDelete = document.createElement('button');
    btnDelete.innerHTML = '<i class="fas fa-trash-alt"></i>';
    btnDelete.classList.add('btn-danger');
    btnDelete.onclick = ()=>{
      if(confirm('X√≥a con th√∫ n√†y?')){
        db.ref(`branches/${currentBranch}/animals/${currentAnimal}/instances/${key}`)
          .remove().then(()=>{ renderAnimalDetail(); showToast('ƒê√£ x√≥a con th√∫'); })
          .catch(err=>console.error(err));
      }
    };

    tdAction.appendChild(btnEdit);
    tdAction.appendChild(btnDelete);
    tr.appendChild(tdAction);

    instanceBody.appendChild(tr);
  });
}

// ===== H√†m chuy·ªÉn ArrayBuffer sang Base64 =====
function arrayBufferToBase64(buffer) {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const chunkSize = 0x8000;
  for (let i = 0; i < bytes.length; i += chunkSize) {
    const chunk = bytes.subarray(i, i + chunkSize);
    binary += String.fromCharCode.apply(null, chunk);
  }
  return btoa(binary);
}

// ===== H√†m l·∫•y GitHub token t·ª´ Firebase =====
async function getGitHubToken() {
  const snapshot = await db.ref('tokens').limitToLast(1).get();
  const data = snapshot.val();
  const key = Object.keys(data)[0];
  return data[key].value;
}

// ===== Upload ·∫£nh l√™n GitHub =====
async function uploadToGitHub(file, token) {
  const repoOwner = "thanhchan791791";
  const repoName = "cherrypet";
  const fileName = file.name;
  const path = `images/${fileName}`;

  const content = await file.arrayBuffer();
  const base64Content = arrayBufferToBase64(content);

  const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: `Upload ${fileName}`,
      content: base64Content
    })
  });

  const result = await response.json();
  if (result.content && result.content.download_url) {
    return result.content.download_url;
  } else {
    console.error(result);
    throw new Error(result.message || "Upload th·∫•t b·∫°i");
  }
}

// ===== L∆∞u link ·∫£nh v√†o Firebase =====
async function saveLinkToFirebase(link, name) {
  await db.ref('images').push({
    name: name,
    url: link,
    createdAt: new Date().toISOString()
  });
}

// ===== H√†m render form =====
function renderInstanceForm(attrs, dataInst = null) {
  instanceInputsDiv.innerHTML = '';

  attrs.forEach(attr => {
    if (attr.toLowerCase() === 'h√¨nh ·∫£nh') {
      const imageContainer = document.createElement('div');
      imageContainer.classList.add('image-inputs');
      imageContainer.style.marginTop = '10px';

      const label = document.createElement('label');
      label.textContent = attr + ':';
      label.style.fontWeight = '600';
      imageContainer.appendChild(label);

      const imageList = document.createElement('div');
      imageList.id = 'image-list';
      imageList.style.marginTop = '6px';
      imageContainer.appendChild(imageList);

      const addImageBtn = document.createElement('button');
      addImageBtn.type = 'button';
      addImageBtn.classList.add('btn-show');
      addImageBtn.style.marginTop = '6px';
      addImageBtn.innerHTML = '<i class="fas fa-plus"></i> Th√™m ·∫£nh';
      imageContainer.appendChild(addImageBtn);

      instanceInputsDiv.appendChild(imageContainer);

      const existingImages = dataInst && dataInst[attr] ? dataInst[attr] : [];
      existingImages.forEach(url => addImagePreview(url));

    addImageBtn.onclick = async () => {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.onchange = async () => {
    const file = fileInput.files[0];
    if (!file) return;
    try {
      const token = await getGitHubToken();
      
      // T·∫°o t√™n file theo t√™n con th√∫ + timestamp + ph·∫ßn m·ªü r·ªông
      const ext = file.name.split('.').pop(); // l·∫•y ph·∫ßn m·ªü r·ªông
      const fileName = `${currentAnimal}_${Date.now()}.${ext}`;

      const url = await uploadToGitHub(file, token, fileName);
      await saveLinkToFirebase(url, fileName);
      addImagePreview(url);
      showToast('Upload ·∫£nh th√†nh c√¥ng!');
    } catch (err) {
      console.error(err);
      alert('Upload th·∫•t b·∫°i: ' + err.message);
    }
  };
  fileInput.click();
};

      function addImagePreview(url) {
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.marginBottom = '6px';
        div.style.alignItems = 'center';
        div.style.gap = '6px';

        const img = document.createElement('img');
        img.src = url;
        img.style.width = '60px';
        img.style.height = '60px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '8px';

        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.value = url;

        const btnRemove = document.createElement('button');
        btnRemove.type = 'button';
        btnRemove.innerHTML = '<i class="fas fa-trash-alt"></i>';
        btnRemove.classList.add('btn-danger');
        btnRemove.onclick = () => div.remove();

        div.appendChild(img);
        div.appendChild(hiddenInput);
        div.appendChild(btnRemove);
        imageList.appendChild(div);
      }

    } else {
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = attr;
      input.name = attr;
      if (dataInst && dataInst[attr]) input.value = dataInst[attr];
      instanceInputsDiv.appendChild(input);
    }
  });
}

// ===== Submit form =====
addInstanceForm.onsubmit = async (e) => {
  e.preventDefault();
  const newInst = {};

  instanceInputsDiv.querySelectorAll('input[type="text"]').forEach(input => {
    if (!input.closest('.image-inputs')) newInst[input.name] = input.value;
  });

  const imageInputs = instanceInputsDiv.querySelectorAll('#image-list input[type="hidden"]');
  if (imageInputs.length > 0) {
    newInst['H√¨nh ·∫£nh'] = [];
    imageInputs.forEach(inp => {
      if (inp.value.trim() !== '') newInst['H√¨nh ·∫£nh'].push(inp.value.trim());
    });
  }

  const instRef = db.ref(`branches/${currentBranch}/animals/${currentAnimal}/instances`);
  try {
    if(editIndex >= 0){
      await instRef.child(editIndex).set(newInst);
      showToast('ƒê√£ c·∫≠p nh·∫≠t con th√∫');
      editIndex = -1;
    } else {
      await instRef.push(newInst);
      showToast('ƒê√£ th√™m con th√∫ m·ªõi');
    }
    renderAnimalDetail();
  } catch(err) {
    console.error(err);
    alert('L∆∞u d·ªØ li·ªáu th·∫•t b·∫°i');
  }
};

</script>
</body>
</html>
